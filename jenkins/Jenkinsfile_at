pipeline {
    agent { label 'usla-jknd-p004' }

    environment {
        IMAGE_TAG = "${env.imageTag}"
        DEPLOY_AND_RUN_ON_DEV = "${env.deployAndRunOnDev}"
        DEPLOY_AND_RUN_ON_QA = "${env.deployAndRunOnQa}"
    }

    stages {
        stage('Setup parameters') {
            steps {
                echo IMAGE_TAG
                echo 'Empty Step'
            }
        }
        stage('Deployment AT') {
            steps {
                script {
                    if (DEPLOY_AND_RUN_ON_DEV.toBoolean()) {
                        echo 'Deploying to DEV Environment ...'
//                        // deploy
//                        dir('kubernetes') {
//                            git url: 'git@github-us.production.tvn.com:Nexus/kubernetes.git'
//                            script {
//                                imageTag = imageTag ?: sh(returnStdout: true, script: "./image-versions.sh dev nexus-avails portal").trim()
//                            }
//                        }
//                        dir('kubernetes/nexus-avails/portal') {
//                            sh "./deploy.sh dev nexus-avails ${IMAGE_TAG}"
//                        }
                    }
                    if (DEPLOY_AND_RUN_ON_QA.toBoolean()) {
                        echo 'Deploying to QA Environment ...'
                        // deploy
//                        dir('kubernetes') {
//                            git url: 'git@github-us.production.tvn.com:Nexus/kubernetes.git'
//                            script {
//                                imageTag = imageTag ?: sh(returnStdout: true, script: "./image-versions.sh qa nexus-avails portal").trim()
//                            }
//                        }
//                        dir('kubernetes/nexus-avails/portal') {
//                            sh "./deploy.sh qa nexus-avails ${IMAGE_TAG}"
//                        }
                    }
                }
            }
        }
        stage('Trigger Automation Pipeline') {
            steps {
                script {
                    if (DEPLOY_AND_RUN_ON_DEV.toBoolean()) {
                        build job: 'LTP/DEV/Sanity/UISanityTests', wait: true
                    }
                    if (DEPLOY_AND_RUN_ON_QA.toBoolean()) {
                        build job: 'LTP/QA/Sanity/UISanityTests', wait: true
                    }
                }
            }
        }
    }
    post {
        success {
            sh 'echo Finished Successfully'
        }
        failure {
            mail to: 'Vikings-VU@Amdocs.onmicrosoft.com', subject: "Build ${currentBuild.fullDisplayName} FAILED", body: "Please go to ${env.BUILD_URL}/consoleText for more details."
        }
    }
}
